#!/usr/bin/env ruby
require 'rubygems'
require 'bundler/setup'
require 'yaml'

environment = ENV["ZOO_STATS_ENV"] || :development
Bundler.require(:default, environment)

require_relative '../lib/input/kafka_reader'
require_relative '../lib/processor'
require_relative '../lib/output/elasticsearch_writer'
require_relative '../lib/models/classification'

def load_config(filename, environment)
  path = File.expand_path(File.join('..', '..', 'config', filename), __FILE__)
  YAML.load_file(path).fetch(environment.to_s)
end

puts "Starting"

es_config = load_config('elasticsearch.yml', environment)
output  = Stats::Output::ElasticsearchWriter.new(es_config)
processor = Stats::Processor.new(output)

kafka_config = load_config('kafka.yml', environment)
kafka_reader = Stats::Input::KafkaReader.new(processor:  processor,
                                             zookeepers: kafka_config.fetch('zookeepers'),
                                             group_name: kafka_config.fetch('consumer_group'),
                                             brokers:    kafka_config.fetch('brokers'),
                                             topic:      kafka_config.fetch('topic'))

puts "Started"

loop do
  kafka_reader.run
  sleep 5
end
