#!/usr/bin/env ruby
require 'rubygems'
require 'bundler/setup'

require_relative '../lib/config'

environment = Stats::Config.stats_environment
Bundler.require(:default, environment)

require_relative '../lib/input/kcl_reader'
require_relative '../lib/processor'
require_relative '../lib/output/elasticsearch_writer'
require_relative '../lib/output/pusher_writer'

STDERR.puts "Starting Stream Reader"

Pusher.url = ENV.fetch("PUSHER_URL")

Geocoder.configure(ip_lookup: :geoip2, geoip2: {
  file: File.expand_path('../../data/GeoLite2-City.mmdb', __FILE__)
})

outputs = [
  Stats::Output::ElasticsearchWriter.new,
  Stats::Output::PusherWriter.new
]

processor = Stats::Processor.new(outputs)

kcl_reader   = Stats::Input::KclReader.new(processor)
driver       = Aws::KCLrb::KCLProcess.new(kcl_reader)
driver.run
